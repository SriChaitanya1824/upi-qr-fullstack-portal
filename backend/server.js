require('dotenv').config();const express=require('express');const mongoose=require('mongoose');const cors=require('cors');const morgan=require('morgan');const path=require('path');const Transaction=require('./models/Transaction');const Feedback=require('./models/Feedback');const app=express();app.use(cors());app.use(express.json());app.use(morgan('dev'));app.use('/static',express.static(path.join(__dirname,'..','frontend')));const PORT=process.env.PORT||4000;const MONGO_URI=process.env.MONGO_URI||'mongodb://localhost:27017/upi_portal';mongoose.connect(MONGO_URI);function buildUpiUri({pa,pn,am,tn,cu='INR'}){const p=[];p.push(`pa=${encodeURIComponent(pa)}`);if(pn)p.push(`pn=${encodeURIComponent(pn)}`);if(am)p.push(`am=${encodeURIComponent(am)}`);if(tn)p.push(`tn=${encodeURIComponent(tn)}`);p.push(`cu=${encodeURIComponent(cu)}`);return`upi://pay?${p.join('&')}`;}app.post('/api/create-qr',async(req,res)=>{try{const{upiId,payeeName,amount,note}=req.body;if(!upiId||!payeeName||!amount)return res.status(400).json({error:'upiId, payeeName and amount required'});const qrRef=`qr_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;const upiUri=buildUpiUri({pa:upiId,pn:payeeName,am:amount,tn:note||qrRef});const txn=new Transaction({upiId,payeeName,amount,note,qrRef,paymentStatus:'pending'});await txn.save();res.json({upiUri,txnId:txn._id,qrRef});}catch(e){res.status(500).json({error:'server error'});}});app.post('/api/confirm-payment',async(req,res)=>{try{const{txnId,paymentTxnId,status}=req.body;if(!txnId)return res.status(400).json({error:'txnId required'});const txn=await Transaction.findById(txnId);if(!txn)return res.status(404).json({error:'transaction not found'});txn.paymentTxnId=paymentTxnId||txn.paymentTxnId;if(status==='paid')txn.paymentStatus='paid';else if(status==='failed')txn.paymentStatus='failed';await txn.save();res.json({ok:true,txn});}catch(e){res.status(500).json({error:'server error'});}});app.get('/api/transactions',async(req,res)=>{const t=await Transaction.find().sort({createdAt:-1}).limit(200);res.json(t);});app.post('/api/feedback',async(req,res)=>{try{const{transactionId,type,rating,message}=req.body;if(!message)return res.status(400).json({error:'message required'});const fb=new Feedback({transactionId,type:type||'feedback',rating,message});await fb.save();res.json({ok:true,feedback:fb});}catch(e){res.status(500).json({error:'server error'});}});app.get('/api/feedbacks',async(req,res)=>{const f=await Feedback.find().sort({createdAt:-1}).limit(500).populate('transactionId');res.json(f);});app.get('/',(req,res)=>{res.sendFile(path.join(__dirname,'..','frontend','index.html'));});app.listen(PORT);